name: Convert 02Engine DEB packages
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  convert-debs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true  # 启用 LFS 支持
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git fakeroot binutils wget zstd \
          file coreutils sed grep git-lfs
        
        # 安装并配置 Git LFS
        git lfs install
        
    - name: Install and setup debtap
      run: |
        # 克隆 debtap
        git clone https://github.com/helixarch/debtap.git
        
        # 创建必要的缓存目录和文件
        sudo mkdir -p /var/cache/debtap
        sudo touch /var/cache/debtap/base-packages
        sudo touch /var/cache/debtap/extended-base-packages-list-temp
        
        # 修补 debtap 脚本，跳过 pkgfile 相关步骤
        sed -i 's/pkgfile -u/echo "跳过 pkgfile 更新"/g' debtap/debtap
        sed -i 's|cat /var/cache/debtap/base-packages|echo "跳过 base-packages 读取"|g' debtap/debtap
        sed -i 's|sort /var/cache/debtap/extended-base-packages-list-temp|echo "跳过 extended-base-packages 排序"|g' debtap/debtap
        
        # 安装 debtap
        sudo cp debtap/debtap /usr/local/bin/debtap
        sudo chmod +x /usr/local/bin/debtap
        
        # 创建其他必要目录
        sudo mkdir -p /usr/share/debtap
        sudo touch /usr/share/debtap/{mirrors.list,debtap.db}
        
    - name: Make scripts executable
      run: |
        chmod +x *.sh
        echo "脚本权限设置完成"
        ls -la
        
    - name: Check environment
      run: |
        echo "=== 环境检查 ==="
        echo "当前目录: $(pwd)"
        echo "脚本列表:"
        ls -la *.sh scripts/*.sh 2>/dev/null || echo "没有找到脚本"
        echo ""
        echo "dist 目录内容:"
        ls -la dist/ 2>/dev/null || echo "dist 目录不存在"
        echo ""
        echo "文件类型检查:"
        for file in dist/*.deb 2>/dev/null; do
          if [ -f "$file" ]; then
            echo "$(basename "$file"): $(file -b "$file") - 大小: $(ls -lh "$file" | cut -d' ' -f5)"
          fi
        done
        
    - name: Run convertarch.sh script
      run: |
        # 设置环境变量
        export TERM=xterm-256color
        
        echo "=== 开始执行 convertarch.sh ==="
        
        # 检查脚本是否存在
        if [ ! -f "convertarch.sh" ]; then
          echo "❌ convertarch.sh 脚本不存在"
          echo "当前目录文件:"
          ls -la
          exit 1
        fi
        
        # 检查脚本是否可执行
        if [ ! -x "convertarch.sh" ]; then
          echo "convertarch.sh 不可执行，添加执行权限"
          chmod +x convertarch.sh
        fi
        
        # 执行您的转换脚本
        ./convertarch.sh
        
    - name: Show final results
      run: |
        echo "=== 最终结果 ==="
        if [ -d "arch-packages" ]; then
          echo "生成的包文件:"
          find arch-packages -name "*.pkg.tar.*" -o -name "*.tar.xz" | while read file; do
            echo "✅ $(basename "$file") - 大小: $(du -h "$file" | cut -f1)"
          done
          echo ""
          echo "目录结构:"
          ls -la arch-packages/
        else
          echo "❌ arch-packages 目录不存在"
          echo "当前目录:"
          ls -la
        fi
        
    - name: Upload Arch packages
      uses: actions/upload-artifact@v4
      with:
        name: 02engine-arch-linux-packages
        path: arch-packages/
        retention-days: 30
        if-no-files-found: warn
