name: Convert 02Engine DEB packages (One by One)
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  convert-debs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies (without pkgfile)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git fakeroot binutils wget zstd \
          file coreutils sed grep
        
    - name: Install and patch debtap
      run: |
        # 克隆 debtap
        git clone https://github.com/helixarch/debtap.git
        
        # 修改 debtap 脚本，移除 pkgfile 依赖
        sed -i 's/pkgfile -u/echo "Skipping pkgfile update"/g' debtap/debtap
        sed -i 's/==> Synchronizing pkgfile database/echo "Skipping pkgfile synchronization"/g' debtap/debtap
        sed -i 's/Synchronization failed/echo "pkgfile sync skipped"/g' debtap/debtap
        
        # 安装 debtap
        sudo cp debtap/debtap /usr/local/bin/debtap
        sudo chmod +x /usr/local/bin/debtap
        
        # 创建必要的目录结构
        sudo mkdir -p /usr/share/debtap
        sudo touch /usr/share/debtap/mirrors.list
        sudo touch /usr/share/debtap/debtap.db
        
    - name: Make scripts executable
      run: |
        chmod +x *.sh
        echo "脚本权限设置完成"
        ls -la
        
    - name: Check dist directory
      run: |
        echo "dist 目录内容:"
        ls -la dist/ || echo "dist 目录不存在或为空"
        
    - name: Convert DEB packages one by one
      run: |
        # 设置环境变量避免终端错误
        export TERM=xterm-256color
        
        # 运行转换脚本
        ./convertarch.sh
        
    - name: Show results
      run: |
        echo "=== 转换结果 ==="
        if [ -d "arch-packages" ]; then
            echo "arch-packages 目录内容:"
            ls -la arch-packages/
            echo ""
            echo "生成的包文件:"
            find arch-packages -name "*.pkg.tar.*" -o -name "*.tar.xz" | while read file; do
                echo "✅ $(basename "$file") - 大小: $(du -h "$file" | cut -f1)"
            done
        else
            echo "❌ arch-packages 目录不存在"
        fi
        
    - name: Upload Arch packages
      uses: actions/upload-artifact@v4
      with:
        name: 02engine-arch-linux-packages
        path: arch-packages/
        retention-days: 30
        if-no-files-found: warn
