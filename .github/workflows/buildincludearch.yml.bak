name: Build Linux (include arch)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install strip-nondeterminism
        run: sudo apt-get update && sudo apt-get install -y strip-nondeterminism

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Clean cache
        run: npm cache clean --force --loglevel=info

      - name: Install dependencies
        run: npm install --force --loglevel=info

      - name: Fetch
        run: npm run fetch

      - name: Compile
        run: npm run webpack:prod

      - name: Package (deb + tar.gz + AppImage)
        run: |
          node release-automation/build.js --debian --tarball --appimage --x64 --armv7l --arm64

      - name: Print file tree
        run: node scripts/print-file-tree.js dist

      - name: Upload artifacts for Arch conversion
        uses: actions/upload-artifact@v4
        with:
          name: arch-conversion-artifacts
          path: |
            dist/*.deb
            convertarch.sh
          retention-days: 1

  convert-to-arch:
    needs: build-linux
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: --privileged

    steps:
      # 1. 准备Arch环境
      - name: Prepare Arch environment
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm sudo git base-devel namcap libarchive zstd
          useradd -m -s /bin/bash builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/builduser
          echo 'export TERM=xterm' >> /etc/bash.bashrc

      # 2. 安装debtap并以root权限运行更新
      - name: Install and update debtap
        run: |
          # 安装debtap
          sudo -u builduser bash <<'EOF'
          set -e
          export TERM=xterm
          cd /home/builduser
          git clone https://aur.archlinux.org/debtap.git
          cd debtap
          makepkg -si --noconfirm
          EOF
          
          # 以root权限运行debtap更新（关键修复）
          echo "正在以root权限运行debtap更新..."
          debtap -u
          echo "debtap更新完成"
          
          # 验证debtap是否正常工作
          debtap --version || echo "debtap版本检查失败，但继续执行"

      # 3. 下载制品
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: arch-conversion-artifacts
          path: /workspace

      # 4. 准备工作目录和修复脚本中的debtap调用
      - name: Setup workspace and fix script
        run: |
          cd /workspace
          ls -la
          chmod +x convertarch.sh
          mkdir -p dist
          find . -name "*.deb" -exec mv {} dist/ \; 2>/dev/null || true
          
          # 修改脚本，确保使用root权限运行debtap
          if [ -f "convertarch.sh" ]; then
            # 备份原脚本
            cp convertarch.sh convertarch.sh.backup
            # 修改debtap调用，使用sudo或直接运行（因为我们在root环境）
            sed -i 's/debtap/sudo debtap/g' convertarch.sh || true
            echo "✅ 脚本已调整以适应root环境"
          fi
          
          echo "可用的deb包:"
          find dist -name "*.deb" | sort

      # 5. 执行转换脚本（在root环境下）
      - name: Run deb → Arch conversion
        working-directory: /workspace
        run: |
          export TERM=xterm
          # 确保在root权限下运行
          ./convertarch.sh

      # 6. 检查生成结果
      - name: Verify generated packages
        working-directory: /workspace
        run: |
          echo "=== 转换结果 ==="
          find . -name "*.pkg.tar.zst" -ls 2>/dev/null | head -10 || echo "未找到Arch包"
          echo "=== arch-packages目录 ==="
          ls -la arch-packages/ 2>/dev/null || echo "arch-packages目录不存在"
          echo "=== 工作目录内容 ==="
          pwd
          ls -la

      # 7. 上传最终产物
      - name: Upload Arch packages
        uses: actions/upload-artifact@v4
        with:
          name: arch-linux-packages
          path: |
            /workspace/arch-packages/*.pkg.tar.zst
            /workspace/dist/*.deb
          
