name: Generate Flatpak Node Sources (Yarn-compatible)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  generate-sources:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      # 启用 Corepack 并固定 Yarn Classic 1.x
      - name: Setup Yarn Classic (1.x)
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate
          yarn --version  # 应该输出 1.22.22

      - name: Install flatpak-node-generator via pipx
        run: |
          python3 -m pip install --user pipx
          python3 -m pipx ensurepath
          pipx install flatpak-node-generator
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # 生成/更新 yarn.lock（只更新 lockfile，不安装依赖）
      - name: Generate or update yarn.lock
        run: |
          # 清理可能存在的冲突 lockfile
          rm -f package-lock.json bun.lockb

          # 使用 --mode=update-lockfile 只生成/更新 yarn.lock
          yarn install --mode=update-lockfile

          # 强制替换 git+ssh 为 https（防止后续 flatpak-builder SSH 失败）
          if [ -f yarn.lock ]; then
            sed -i 's|git+ssh://git@github.com/|https://github.com/|g' yarn.lock || true
            sed -i 's|git@github.com:|https://github.com/|g' yarn.lock || true
            echo "yarn.lock after protocol replacement:"
            head -n 50 yarn.lock
          else
            echo "yarn.lock was not generated!"
            exit 1
          fi

      - name: Remove node_modules (safety)
        run: rm -rf node_modules || true

      # 生成 Yarn 专属 generated-sources.json
      - name: Generate generated-sources.json (Yarn mode)
        run: |
          if [ -f yarn.lock ]; then
            flatpak-node-generator yarn yarn.lock \
              --output generated-sources.json
          else
            echo "yarn.lock missing, skipping generation"
            exit 1
          fi

      - name: Upload generated-sources.json
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-sources-yarn
          path: generated-sources.json
          if-no-files-found: error
          retention-days: 14

      - name: Upload Yarn lockfile and related files
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-yarn-files
          path: |
            yarn.lock
            package.json
            generated-sources.json
          if-no-files-found: warn
          retention-days: 7

      - name: Upload failure logs and backups
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs-and-backup
          path: |
            yarn.lock
            package-lock.json.bak
            **/*.log
            npm-debug.log
          retention-days: 3
