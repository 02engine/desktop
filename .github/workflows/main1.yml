name: Generate Flatpak Node Sources (generated-sources.json)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # 支持手动触发（推荐用于生成 sources）

jobs:
  generate-sources:
    runs-on: ubuntu-24.04   # 推荐较新版本，确保 pipx 和工具可用

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 需要完整历史记录来处理 git deps（如果有）

      - name: Setup Node.js (for npm and flatpak-node-generator deps)
        uses: actions/setup-node@v4
        with:
          node-version: '20'   # 或你的项目所需版本，如 20 或 22

      - name: Install flatpak-node-generator via pipx
        run: |
          python3 -m pip install --user pipx
          python3 -m pipx ensurepath
          pipx install flatpak-node-generator
          # 确保在 PATH 中（pipx 默认加到 ~/.local/bin）
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Generate or update package-lock.json (without installing node_modules)
        run: npm install --package-lock-only --ignore-scripts

      # 重要：确保运行前没有 node_modules（避免 flatpak-node-generator 误判为 local sources）
      - name: Remove node_modules if exists (safety)
        run: rm -rf node_modules || true

      - name: Generate generated-sources.json using flatpak-node-generator
        run: |
          flatpak-node-generator npm package-lock.json \
            --output generated-sources.json \

      - name: Upload generated-sources.json as artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-sources
          path: generated-sources.json
          if-no-files-found: error
          retention-days: 14

      - name: Upload related files (for easy merging to manifest)
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-related-files
          path: |
            package-lock.json
            package.json
            # 如果你的 manifest 在 flatpak/ 目录下，可加：
            # flatpak/*.yml
            # flatpak/*.yaml
          if-no-files-found: warn
          retention-days: 7

      # 可选：如果生成失败，上传日志方便 debug
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: generation-logs
          path: |
            **/*.log
            npm-debug.log
          retention-days: 3
