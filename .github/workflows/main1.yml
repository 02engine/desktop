name: Generate Flatpak Node Sources (Yarn-compatible)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  generate-sources:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ────────────────────────────────────────────────────────────────
      # 安装 Yarn Classic (1.x) 并启用 corepack（推荐固定版本避免不兼容）
      # ────────────────────────────────────────────────────────────────
      - name: Setup Yarn Classic
        run: |
          corepack enable yarn
          corepack prepare yarn@1.22.22 --activate   # 固定 Yarn 1.x 稳定版
          yarn --version   # 验证是 1.x

      - name: Install flatpak-node-generator via pipx
        run: |
          python3 -m pip install --user pipx
          python3 -m pipx ensurepath
          pipx install flatpak-node-generator
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # ────────────────────────────────────────────────────────────────
      # 生成 yarn.lock（Yarn 的 lockfile）
      # ────────────────────────────────────────────────────────────────
      - name: Generate or update yarn.lock
        run: |
          # 如果项目已有 package-lock.json，先删除避免冲突
          rm -f package-lock.json
          # 用 Yarn 生成 lockfile（不安装 node_modules）
          yarn install --mode=skip-build --frozen-lockfile || true
          # 如果项目有 git deps，确保协议是 https（Yarn 默认支持）
          # 可选：如果 lockfile 仍有 ssh，可加 sed 替换
          sed -i 's|git+ssh://git@github.com/|https://github.com/|g' yarn.lock || true
          sed -i 's|git@github.com:|https://github.com/|g' yarn.lock || true

      # 显示 yarn.lock 变更（debug）
      - name: Show yarn.lock changes
        run: git diff yarn.lock || true

      - name: Remove node_modules (safety)
        run: rm -rf node_modules || true

      # ────────────────────────────────────────────────────────────────
      # 使用 flatpak-node-generator 生成 Yarn 专属 sources
      # ────────────────────────────────────────────────────────────────
      - name: Generate generated-sources.json (Yarn mode)
        run: |
          flatpak-node-generator yarn yarn.lock \
            --output generated-sources.json

      - name: Upload generated-sources.json
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-sources-yarn
          path: generated-sources.json
          if-no-files-found: error
          retention-days: 14

      - name: Upload Yarn lockfile and related files
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-related-files-yarn
          path: |
            yarn.lock
            package.json
            generated-sources.json
          if-no-files-found: warn
          retention-days: 7

      - name: Upload logs & backup on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs-and-backup
          path: |
            yarn.lock.bak
            npm-debug.log
            **/*.log
          retention-days: 3
