name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false
      - name: Purge Node.js caches
        run: |
          rm -rf node_modules
          npm cache clean --force
          rm -rf ~/.npm
          rm -rf dist
          rm -rf .cache
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: ''
      - name: Clean cache
        run: npm cache clean --force --loglevel=info
      - name: Install dependencies
        run: npm install --force --loglevel=info
      - name: Fetch
        run: npm run fetch
      - name: Compile
        run: npm run webpack:prod
      - name: Package
        run: |
          node release-automation/build.js --debian --tarball --appimage --x64 --armv7l --arm64 --production
      - name: Print file tree
        run: node scripts/print-file-tree.js dist
      - name: Upload artifacts to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: |
            dist/*.deb
            dist/*.tar.gz
            dist/*.AppImage
      - name: Upload artifacts to tag
        uses: xresloader/upload-to-github-release@v2
        with:
          file: dist/*.deb;dist/*.tar.gz;dist/*.AppImage
          draft: false

  release-mac:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false
      - name: Purge Node.js caches
        run: |
          rm -rf node_modules
          npm cache clean --force
          rm -rf ~/.npm
          rm -rf dist
          rm -rf .cache
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: ''
      - name: Clean cache
        run: npm cache clean --force --loglevel=info
      - name: Install dependencies
        run: npm install --force --loglevel=info
      - name: Fetch
        run: npm run fetch
      - name: Compile
        run: npm run webpack:prod
      - name: Package
        run: |
          node release-automation/build.js --mac --universal
          node release-automation/build.js --mac-legacy-10.13-10.14 --mac-legacy-10.15 --x64
      - name: Print file tree
        run: node scripts/print-file-tree.js dist
      - name: Upload artifacts to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: mac
          path: dist/*.dmg
      - name: Upload artifacts to tag
        uses: xresloader/upload-to-github-release@v2
        with:
          file: dist/*.dmg
          draft: false

  release-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false
          path: repo
      - name: Move repository to D: drive
        run: |
          Copy-Item -Path repo -Destination D:\repo -Recurse
          Remove-Item -Path repo -Recurse -Force
      - name: Purge Node.js caches
        run: |
          Remove-Item -Path D:\repo\node_modules -Recurse -Force -ErrorAction SilentlyContinue
          npm cache clean --force
          Remove-Item -Path $env:USERPROFILE\.npm -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path D:\repo\dist -Recurse -Force -ErrorAction SilentlyContinue
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: ''
      - name: Configure npm to use D: drive
        run: |
          npm config set cache D:\npm-cache
          npm config set prefix D:\npm-prefix
      - name: Clean cache
        run: npm cache clean --force --loglevel=info
      - name: Install dependencies
        working-directory: D:\repo
        run: npm install --force --loglevel=info
      - name: Fetch
        working-directory: D:\repo
        run: npm run fetch
      - name: Compile
        working-directory: D:\repo
        run: npm run webpack:prod
      - name: Package
        working-directory: D:\repo
        run: |
          node release-automation/build.js --windows --microsoft-store --x64 --ia32 --arm64 --production
          node release-automation/build.js --windows-portable --x64 --production
          node release-automation/build.js --windows-legacy --ia32 --x64 --production
      - name: Print file tree
        working-directory: D:\repo
        run: node scripts/print-file-tree.js dist
      - name: Upload unsigned artifacts to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: windows-unsigned
          path: D:\repo\dist\*.exe
      - name: Upload signed artifacts to tag
        uses: xresloader/upload-to-github-release@v2
        with:
          file: D:\repo\dist\*.exe
          draft: false
