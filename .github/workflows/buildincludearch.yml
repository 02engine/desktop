name: Build Linux (include arch)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install strip-nondeterminism
        run: sudo apt-get update && sudo apt-get install -y strip-nondeterminism

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Clean cache
        run: npm cache clean --force --loglevel=info

      - name: Install dependencies
        run: npm install --force --loglevel=info

      - name: Fetch
        run: npm run fetch

      - name: Compile
        run: npm run webpack:prod

      - name: Package (deb + tar.gz + AppImage)
        run: |
          node release-automation/build.js --debian --tarball --appimage --x64 --armv7l --arm64

      - name: Print file tree
        run: node scripts/print-file-tree.js dist

      # 上传deb包和convertarch.sh脚本
      - name: Upload artifacts for Arch conversion
        uses: actions/upload-artifact@v4
        with:
          name: arch-conversion-artifacts
          path: |
            dist/*.deb
            convertarch.sh
          retention-days: 1

  convert-to-arch:
    needs: build-linux
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: --privileged

    steps:
      # 1. 准备Arch环境
      - name: Prepare Arch environment
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm sudo git base-devel namcap bsdtar zstd
          useradd -m -s /bin/bash builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/builduser
          echo 'export TERM=xterm' >> /etc/bash.bashrc

      # 2. 安装debtap
      - name: Install debtap from AUR
        run: |
          sudo -u builduser bash <<'EOF'
          set -e
          export TERM=xterm
          cd /home/builduser
          git clone https://aur.archlinux.org/debtap.git
          cd debtap
          makepkg -si --noconfirm
          debtap -u || debtap -u || true
          EOF

      # 3. 下载包含deb包和脚本的制品
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: arch-conversion-artifacts
          path: /workspace

      # 4. 准备工作目录和脚本
      - name: Setup workspace
        run: |
          cd /workspace
          ls -la
          chmod +x convertarch.sh
          mkdir -p dist
          mv *.deb dist/ 2>/dev/null || true
          echo "当前目录结构:"
          find . -type f -name "*.deb" -o -name "*.sh" | sort

      # 5. 执行转换脚本
      - name: Run deb → Arch conversion
        working-directory: /workspace
        run: |
          export TERM=xterm
          ./convertarch.sh

      # 6. 检查生成结果
      - name: Verify generated packages
        working-directory: /workspace
        run: |
          echo "生成的Arch包:"
          find . -name "*.pkg.tar.zst" -ls 2>/dev/null || echo "未找到Arch包"
          echo "最终目录结构:"
          ls -la arch-packages/ 2>/dev/null || ls -la

      # 7. 上传最终产物
      - name: Upload Arch packages
        uses: actions/upload-artifact@v4
        with:
          name: arch-linux-packages
          path: |
            /workspace/arch-packages/*.pkg.tar.zst
            /workspace/dist/*.deb
          
