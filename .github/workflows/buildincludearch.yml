name: Build Linux (include arch)

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install strip-nondeterminism
        run: sudo apt-get update && sudo apt-get install -y strip-nondeterminism

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Clean cache
        run: npm cache clean --force --loglevel=info

      - name: Install dependencies
        run: npm install --force --loglevel=info

      - name: Fetch
        run: npm run fetch

      - name: Compile
        run: npm run webpack:prod

      - name: Package (deb + tar.gz + AppImage)
        run: |
          node release-automation/build.js --debian --tarball --appimage --x64 --armv7l --arm64

      - name: Print file tree
        run: node scripts/print-file-tree.js dist

      - name: Upload artifacts for Arch conversion
        uses: actions/upload-artifact@v4
        with:
          name: arch-conversion-artifacts
          path: |
            dist/*.deb
            convertarch.sh
          retention-days: 1

  convert-to-arch:
    needs: build-linux
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: --privileged

    steps:
      # 1. 准备Arch环境（修复包名问题）
      - name: Prepare Arch environment
        run: |
          pacman -Syu --noconfirm
          # 安装必要的依赖包（bsdtar在libarchive包中）
          pacman -S --noconfirm sudo git base-devel namcap libarchive zstd
          useradd -m -s /bin/bash builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/builduser
          echo 'export TERM=xterm' >> /etc/bash.bashrc
          # 验证bsdtar是否安装成功
          bsdtar --version && echo "bsdtar安装成功"

      # 2. 安装debtap
      - name: Install debtap from AUR
        run: |
          sudo -u builduser bash <<'EOF'
          set -e
          export TERM=xterm
          cd /home/builduser
          git clone https://aur.archlinux.org/debtap.git
          cd debtap
          makepkg -si --noconfirm
          debtap -u || debtap -u || true
          EOF

      # 3. 下载制品
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: arch-conversion-artifacts
          path: /workspace

      # 4. 准备工作目录
      - name: Setup workspace
        run: |
          cd /workspace
          ls -la
          # 确保脚本存在且有执行权限
          if [ -f "convertarch.sh" ]; then
            chmod +x convertarch.sh
            echo "✅ convertarch.sh脚本准备就绪"
          else
            echo "❌ convertarch.sh脚本未找到"
            exit 1
          fi
          # 创建dist目录并移动deb包
          mkdir -p dist
          find . -name "*.deb" -exec mv {} dist/ \; 2>/dev/null || true
          echo "当前deb包:"
          find dist -name "*.deb" | sort

      # 5. 执行转换脚本
      - name: Run deb → Arch conversion
        working-directory: /workspace
        run: |
          export TERM=xterm
          ./convertarch.sh

      # 6. 检查生成结果
      - name: Verify generated packages
        working-directory: /workspace
        run: |
          echo "=== 生成的Arch包 ==="
          find . -name "*.pkg.tar.zst" -ls 2>/dev/null || echo "未找到Arch包"
          echo "=== arch-packages目录 ==="
          ls -la arch-packages/ 2>/dev/null || echo "arch-packages目录不存在"
          echo "=== 当前工作目录 ==="
          pwd
          ls -la

      # 7. 上传最终产物
      - name: Upload Arch packages
        uses: actions/upload-artifact@v4
        with:
          name: arch-linux-packages
          path: |
            /workspace/arch-packages/*.pkg.tar.zst
            /workspace/dist/*.deb
        
