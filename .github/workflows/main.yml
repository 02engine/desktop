name: Download Fixed File
on:
  push:
    branches: [ main ]

jobs:
  download-file:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create dist folder
        run: mkdir -p dist

      - name: Download and rename file
        run: |
          cd dist
          curl -L -o "1.deb" "https://release-assets.githubusercontent.com/github-production-release-asset/1034855700/1fb80257-cf00-4bdd-b7df-0c2dcf923db1?sp=r&sv=2018-11-09&sr=b&spr=https&se=2025-11-25T06%3A07%3A11Z&rscd=attachment%3B+filename%3D02Engine-linux-arm64-1.1.8.deb&rsct=application%2Foctet-stream&skoid=96c2d410-5711-43a1-aedd-ab1947aa7ab0&sktid=398a6654-997b-47e9-b12b-9515b896b4de&skt=2025-11-25T05%3A06%3A50Z&ske=2025-11-25T06%3A07%3A11Z&sks=b&skv=2018-11-09&sig=YINvHKw%2BD%2FZU1jUVwq1jcymmczS1p%2B8wnyd%2FRndMw%2BU%3D&jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmVsZWFzZS1hc3NldHMuZ2l0aHVidXNlcmNvbnRlbnQuY29tIiwia2V5Ijoia2V5MSIsImV4cCI6MTc2NDA1MTMxMiwibmJmIjoxNzY0MDQ3NzEyLCJwYXRoIjoicmVsZWFzZWFzc2V0cHJvZHVjdGlvbi5ibG9iLmNvcmUud2luZG93cy5uZXQifQ.difzA893nomNlfO11KflQ2_m5B-m4JYWo6xB8qiEcjQ&response-content-disposition=attachment%3B%20filename%3D02Engine-linux-arm64-1.1.8.deb&response-content-type=application%2Foctet-stream"

      - name: List downloaded files
        run: ls -la dist/
        
  
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git fakeroot binutils wget zstd \
          file coreutils sed grep git-lfs
        
        # 安装并配置 Git LFS
        git lfs install
        
    - name: Install and setup debtap
      run: |
        # 克隆 debtap
        git clone https://github.com/helixarch/debtap.git
        
        # 创建必要的缓存目录和文件
        sudo mkdir -p /var/cache/debtap
        sudo touch /var/cache/debtap/base-packages
        sudo touch /var/cache/debtap/extended-base-packages-list-temp
        
        # 修补 debtap 脚本，跳过 pkgfile 相关步骤
        sed -i 's/pkgfile -u/echo "跳过 pkgfile 更新"/g' debtap/debtap
        sed -i 's|cat /var/cache/debtap/base-packages|echo "跳过 base-packages 读取"|g' debtap/debtap
        sed -i 's|sort /var/cache/debtap/extended-base-packages-list-temp|echo "跳过 extended-base-packages 排序"|g' debtap/debtap
        
        # 安装 debtap
        sudo cp debtap/debtap /usr/local/bin/debtap
        sudo chmod +x /usr/local/bin/debtap
        
        # 创建其他必要目录
        sudo mkdir -p /usr/share/debtap
        sudo touch /usr/share/debtap/{mirrors.list,debtap.db}
        
    - name: Make scripts executable
      run: |
        chmod +x *.sh
        echo "脚本权限设置完成"
        ls -la

    - name: Run convertarch.sh script
      run: |
        # 设置环境变量
        export TERM=xterm-256color
        
        echo "=== 开始执行 convertarch.sh ==="
        
        # 检查脚本是否存在
        if [ ! -f "convertarch.sh" ]; then
          echo "❌ convertarch.sh 脚本不存在"
          echo "当前目录文件:"
          ls -la
          exit 1
        fi
        
        # 检查脚本是否可执行
        if [ ! -x "convertarch.sh" ]; then
          echo "convertarch.sh 不可执行，添加执行权限"
          chmod +x convertarch.sh
        fi
        
        # 执行您的转换脚本
        ./convertarch.sh
        
    - name: Show final results
      run: |
        echo "=== 最终结果 ==="
        if [ -d "arch-packages" ]; then
          echo "生成的包文件:"
          find arch-packages -name "*.pkg.tar.*" -o -name "*.tar.xz" | while read file; do
            echo "✅ $(basename "$file") - 大小: $(du -h "$file" | cut -f1)"
          done
          echo ""
          echo "目录结构:"
          ls -la arch-packages/
        else
          echo "❌ arch-packages 目录不存在"
          echo "当前目录:"
          ls -la
        fi
        
    - name: Upload Arch packages
      uses: actions/upload-artifact@v4
      with:
        name: 02engine-arch-linux-packages
        path: arch-packages/
        retention-days: 30
        if-no-files-found: warn