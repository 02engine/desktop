name: Generate package-lock.json and Flatpak sources

on:
  workflow_dispatch:          # 允许手动触发（最常用）
  push:
    branches: [main, master]  # 或者你想自动触发的分支
  pull_request:
    branches: [main, master]

jobs:
  generate-sources:
    runs-on: ubuntu-latest      # 必须用 Linux runner，因为 flatpak-node-generator 是 Python 脚本

    steps:
      # ─────────────── 检出代码 ───────────────
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0        # 如果需要完整历史

      # ─────────────── 设置 Node.js ───────────────
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  

      # ─────────────── 生成或更新 package-lock.json ───────────────
      - name: Generate / Update package-lock.json
        run: |
          # 如果你想强制重新生成 lockfile（忽略旧的）
          rm -f package-lock.json
          
          # 安装依赖，生成 lockfile
          npm install --legacy-peer-deps --package-lock-only
          

      # ─────────────── 安装 flatpak-node-generator ───────────────
      - name: Install flatpak-node-generator
        run: |
          python -m pip install --user pipx
          python -m pipx ensurepath
          # 等待 PATH 更新（有时需要 source）
          source ~/.profile || true
          pipx install git+https://github.com/flatpak/flatpak-builder-tools.git#subdirectory=node

      # ─────────────── 运行 flatpak-node-generator 生成 sources ───────────────
      - name: Generate generated-sources.json
        run: |
          # 推荐参数：--xdg-layout 符合 Flatpak 规范
          flatpak-node-generator npm package-lock.json \
            --xdg-layout \
            -o generated-sources.json

      # ─────────────── 上传生成的两个文件作为 artifact（供下载） ───────────────
      - name: Upload generated files
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-sources
          path: |
            package-lock.json
            generated-sources.json
          if-no-files-found: error
          retention-days: 14

      # ─────────────── （可选）显示生成结果摘要 ───────────────
      - name: Show summary
        run: |
          echo "package-lock.json size:"
          ls -lh package-lock.json
          echo ""
          echo "generated-sources.json size & first few lines:"
          ls -lh generated-sources.json
          head -n 20 generated-sources.json || cat generated-sources.json
