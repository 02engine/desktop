name: Build Flatpak Bundle

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # 允许手动从 GitHub 界面触发

jobs:
  build:
    name: Build Flatpak (x86_64)
    runs-on: ubuntu-24.04

    # 使用官方预构建容器（包含 flatpak-builder、runtimes 等，避免 not found 错误）
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:gnome-48
      options: --privileged  # flatpak-builder 需要此权限运行 bwrap 等

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: recursive  # 如果有 git 子模块

      - name: 添加 Flathub 远程仓库
        run: |
          flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo

      - name: 安装 Node.js 20 SDK 扩展（manifest 需要）
        run: |
          flatpak install --noninteractive --user \
            org.freedesktop.Sdk.Extension.node20//24.08

      - name: 使用 flatpak-builder 构建应用
        run: |
          flatpak-builder \
            --user \
            --install-deps-from=flathub \
            --force-clean \
            --repo=repo \
            --ccache \
            --default-branch=main \
            --arch=x86_64 \
            build-dir \
            io.github._02engine._02Engine.yml

      - name: 生成 .flatpak 单文件 bundle
        run: |
          flatpak build-bundle \
            repo \
            02Engine.flatpak \
            io.github._02engine._02Engine \
            main

      - name: 上传 Flatpak bundle 作为 artifact
        uses: actions/upload-artifact@v4
        with:
          name: 02Engine-flatpak-bundle
          path: 02Engine.flatpak
          if-no-files-found: error
          retention-days: 14

      - name: 上传构建日志（仅失败时）
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-logs
          path: |
            build-dir/*.log
            **/*.log
          retention-days: 7
