name: Build (Auto)

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DEBUG: "electron-builder"
      DEBUG_PROD: "true"
      ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES: "true"

    steps:
    - name: ðŸ“‹ çŽ¯å¢ƒå˜é‡æ£€æŸ¥
      run: |
        echo "=== çŽ¯å¢ƒå˜é‡ ==="
        env | sort
        echo "=== Node ç‰ˆæœ¬ ==="
        node --version
        echo "=== Bun ç‰ˆæœ¬ ==="
        bun --version
        echo "=== npm ç‰ˆæœ¬ ==="
        npm --version
        echo "=== å½“å‰ç›®å½• ==="
        pwd
        echo "=== ç£ç›˜ç©ºé—´ ==="
        df -h

    - uses: actions/checkout@v4
      with:
        submodules: recursive
        persist-credentials: false

    - name: ðŸ“ Checkout åŽç›®å½•ç»“æž„
      run: |
        echo "=== æ ¹ç›®å½•ç»“æž„ ==="
        ls -la
        echo "=== src-main ç›®å½• ==="
        ls -la src-main/ 2>/dev/null || echo "âš ï¸ src-main ç›®å½•ä¸å­˜åœ¨"
        echo "=== æ£€æŸ¥ entrypoint.js ==="
        find . -name "entrypoint.js" -o -name "entrypoint.ts" 2>/dev/null || echo "âš ï¸ æœªæ‰¾åˆ°å…¥å£æ–‡ä»¶"

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: Setup bun âš™ï¸
      uses: oven-sh/setup-bun@v2

    - name: ðŸ“¦ å®‰è£…ä¾èµ–å‰æ£€æŸ¥
      run: |
        echo "=== package.json å†…å®¹ ==="
        cat package.json
        echo "=== package.json ä¸­çš„ main å­—æ®µ ==="
        node -e "console.log(JSON.parse(require('fs').readFileSync('package.json')).main)"

    - name: Install dependencies
      run: |
        echo "=== å¼€å§‹å®‰è£…ä¾èµ– ==="
        bun install --loglevel=verbose
        echo "=== å®‰è£…å®Œæˆï¼Œæ£€æŸ¥ node_modules ==="
        ls -la node_modules/ | head -20
        echo "=== ä¾èµ–æ€»æ•° ==="
        ls node_modules/ | wc -l

    - name: Prepare extensions
      run: |
        echo "=== å‡†å¤‡æ‰©å±• ==="
        node scripts/prepare-extensions.js
        echo "=== æ‰©å±•å‡†å¤‡å®ŒæˆåŽçš„ç›®å½• ==="
        ls -la dist-extensions/ 2>/dev/null || echo "âš ï¸ dist-extensions ç›®å½•ä¸å­˜åœ¨"

    - name: ðŸ“ Compile å‰æ£€æŸ¥
      run: |
        echo "=== webpack é…ç½® ==="
        cat webpack.config.js 2>/dev/null || echo "âš ï¸ æœªæ‰¾åˆ° webpack.config.js"
        echo "=== TypeScript é…ç½® ==="
        cat tsconfig.json 2>/dev/null || echo "âš ï¸ æœªæ‰¾åˆ° tsconfig.json"

    - name: Compile
      run: |
        echo "=== å¼€å§‹ç¼–è¯‘ ==="
        npm run webpack:compile
        echo "=== ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºç›®å½• ==="
        echo "--- dist ç›®å½• ---"
        ls -la dist/ 2>/dev/null || echo "âš ï¸ dist ç›®å½•ä¸å­˜åœ¨"
        echo "--- src-main ç›®å½• ---"
        ls -la src-main/ 2>/dev/null || echo "âš ï¸ src-main ç›®å½•ä¸å­˜åœ¨"
        echo "--- æŸ¥æ‰¾æ‰€æœ‰ .js å…¥å£æ–‡ä»¶ ---"
        find . -name "*.js" -path "*/src-main/*" 2>/dev/null || echo "âš ï¸ src-main ä¸­æ—  JS æ–‡ä»¶"

    - name: ðŸ” æ‰“åŒ…å‰æœ€ç»ˆæ£€æŸ¥
      run: |
        echo "=== å®Œæ•´ç›®å½•æ ‘ (å‰ 100 è¡Œ) ==="
        find . -type f -name "*.js" | head -100
        echo "=== æ£€æŸ¥ package.json build é…ç½® ==="
        node -e "console.log(JSON.stringify(JSON.parse(require('fs').readFileSync('package.json')).build, null, 2))"
        echo "=== ç¡®è®¤å…¥å£æ–‡ä»¶è·¯å¾„ ==="
        MAIN_FILE=$(node -e "console.log(JSON.parse(require('fs').readFileSync('package.json')).main)")
        echo "å…¥å£æ–‡ä»¶é…ç½®ä¸ºï¼š$MAIN_FILE"
        if [ -f "$MAIN_FILE" ]; then
          echo "âœ… å…¥å£æ–‡ä»¶å­˜åœ¨"
          head -5 "$MAIN_FILE"
        else
          echo "âŒ å…¥å£æ–‡ä»¶ä¸å­˜åœ¨ï¼"
          echo "å°è¯•æŸ¥æ‰¾ç±»ä¼¼æ–‡ä»¶:"
          find . -name "entrypoint*" 2>/dev/null
          find . -name "index*" -path "*/src-main/*" 2>/dev/null
        fi

    - name: Package
      run: |
        echo "=== å¼€å§‹æ‰“åŒ… ==="
        echo "=== å½“å‰å·¥ä½œç›®å½• ==="
        pwd
        echo "=== æ‰“åŒ…å‘½ä»¤ ==="
        cat package.json | grep -A 5 '"scripts"'
        echo "=== æ‰§è¡Œæ‰“åŒ… ==="
        npm run electron:package:dir 2>&1 | tee package-log.txt
        echo "=== æ‰“åŒ…å®Œæˆï¼Œæ£€æŸ¥è¾“å‡º ==="
        ls -la dist/ 2>/dev/null || echo "âš ï¸ dist ç›®å½•ä¸å­˜åœ¨"
        ls -la dist/linux-unpacked/ 2>/dev/null || echo "âš ï¸ dist/linux-unpacked ç›®å½•ä¸å­˜åœ¨"
        ls -la dist/linux-unpacked/resources/app/ 2>/dev/null || echo "âš ï¸ app èµ„æºç›®å½•ä¸å­˜åœ¨"

    - name: ðŸ“Š ä¸Šä¼ æž„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          package-log.txt
          dist/**/*
        retention-days: 14

    - name: ðŸ“Š ä¸Šä¼ å®Œæ•´ç›®å½•å¿«ç…§
      if: failure()
      run: |
        echo "=== æž„å»ºå¤±è´¥ï¼Œç”Ÿæˆå®Œæ•´ç›®å½•å¿«ç…§ ==="
        find . -type f -name "*.json" | head -50 > file-list.txt
        find . -type f -name "*.js" | head -100 >> file-list.txt
        cat file-list.txt
