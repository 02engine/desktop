name: Build (Auto)

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DEBUG: "electron-builder"

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        persist-credentials: false

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: Setup bun âš™ï¸
      uses: oven-sh/setup-bun@v2

    - name: Install dependencies
      run: bun install --loglevel=info

    - name: Prepare extensions
      run: node scripts/prepare-extensions.js

    - name: Compile
      run: npm run webpack:compile

    # ========== æ‰“åŒ…å‰è¯Šæ–­é˜¶æ®µ ==========
    - name: ðŸ“‹ æ‰“åŒ…å‰è¯Šæ–­ - æ£€æŸ¥å…¥å£æ–‡ä»¶
      run: |
        echo "=== æ£€æŸ¥ package.json main å­—æ®µ ==="
        cat package.json | grep -A 2 '"main"'
        
        echo ""
        echo "=== æŸ¥æ‰¾æ‰€æœ‰ entrypoint ç›¸å…³æ–‡ä»¶ ==="
        find . -name "entrypoint*" -type f 2>/dev/null || echo "æœªæ‰¾åˆ° entrypoint æ–‡ä»¶"
        
        echo ""
        echo "=== æ£€æŸ¥ src-main ç›®å½•å†…å®¹ ==="
        if [ -d "src-main" ]; then
          ls -la src-main/
          echo ""
          echo "=== src-main ç›®å½•æ ‘çŠ¶ç»“æž„ ==="
          find src-main -type f | head -50
        else
          echo "âš ï¸ src-main ç›®å½•ä¸å­˜åœ¨!"
        fi
        
        echo ""
        echo "=== æ£€æŸ¥ dist ç›®å½•å†…å®¹ ==="
        if [ -d "dist" ]; then
          ls -la dist/
        else
          echo "â„¹ï¸ dist ç›®å½•å°šæœªåˆ›å»ºï¼ˆæ­£å¸¸ï¼‰"
        fi

    - name: ðŸ“‹ æ‰“åŒ…å‰è¯Šæ–­ - æ£€æŸ¥ electron-builder é…ç½®
      run: |
        echo "=== package.json ä¸­çš„ build é…ç½® ==="
        cat package.json | jq '.build' 2>/dev/null || cat package.json | grep -A 200 '"build"'
        
        echo ""
        echo "=== å½“å‰å·¥ä½œç›®å½• ==="
        pwd
        
        echo ""
        echo "=== é¡¹ç›®æ ¹ç›®å½•æ–‡ä»¶åˆ—è¡¨ ==="
        ls -la

    # ========== æ‰“åŒ…é˜¶æ®µï¼ˆå¸¦è¯¦ç»†æ—¥å¿—ï¼‰==========
    - name: ðŸ“¦ Package Electron (è¯¦ç»†æ—¥å¿—)
      run: |
        echo "=== å¼€å§‹æ‰“åŒ…ï¼Œæ—¶é—´: $(date) ==="
        
        echo ""
        echo "=== çŽ¯å¢ƒå˜é‡ ==="
        env | grep -E "(DEBUG|ELECTRON|NODE)" || echo "æ— ç›¸å…³çŽ¯å¢ƒå˜é‡"
        
        echo ""
        echo "=== npm ç‰ˆæœ¬ä¿¡æ¯ ==="
        npm --version
        node --version
        bun --version
        
        echo ""
        echo "=== æ‰§è¡Œ electron-builder å¸¦è¯¦ç»†æ—¥å¿— ==="
        # è®¾ç½®æœ€é«˜çº§åˆ«è°ƒè¯•
        export DEBUG=electron-builder:*
        export ELECTRON_BUILDER_LOG_LEVEL=debug
        
        # è¿è¡Œæ‰“åŒ…å‘½ä»¤ï¼Œæ•èŽ·æ‰€æœ‰è¾“å‡º
        npm run electron:package:dir 2>&1 | tee package.log
        
        echo ""
        echo "=== æ‰“åŒ…å®Œæˆï¼Œæ—¶é—´: $(date) ==="

    # ========== æ‰“åŒ…åŽè¯Šæ–­é˜¶æ®µ ==========
    - name: ðŸ“‹ æ‰“åŒ…åŽè¯Šæ–­ - æ£€æŸ¥è¾“å‡ºç›®å½•
      if: always()
      run: |
        echo "=== æ£€æŸ¥ dist ç›®å½•ç»“æž„ ==="
        if [ -d "dist" ]; then
          echo ""
          echo "=== dist ç›®å½•å†…å®¹ ==="
          ls -la dist/
          
          echo ""
          echo "=== linux-unpacked ç›®å½•å†…å®¹ ==="
          if [ -d "dist/linux-unpacked" ]; then
            ls -la dist/linux-unpacked/
            
            echo ""
            echo "=== resources/app ç›®å½•å†…å®¹ ==="
            if [ -d "dist/linux-unpacked/resources/app" ]; then
              ls -la dist/linux-unpacked/resources/app/
              
              echo ""
              echo "=== src-main åœ¨æ‰“åŒ…åŽçš„å†…å®¹ ==="
              if [ -d "dist/linux-unpacked/resources/app/src-main" ]; then
                ls -la dist/linux-unpacked/resources/app/src-main/
              else
                echo "âš ï¸ dist/linux-unpacked/resources/app/src-main ç›®å½•ä¸å­˜åœ¨!"
              fi
              
              echo ""
              echo "=== æŸ¥æ‰¾æ‰€æœ‰ .js å…¥å£æ–‡ä»¶ ==="
              find dist/linux-unpacked/resources/app -name "*.js" -type f | head -30
            else
              echo "âš ï¸ resources/app ç›®å½•ä¸å­˜åœ¨!"
            fi
          else
            echo "âš ï¸ dist/linux-unpacked ç›®å½•ä¸å­˜åœ¨!"
          fi
        else
          echo "âš ï¸ dist ç›®å½•ä¸å­˜åœ¨!"
        fi
        
        echo ""
        echo "=== å®Œæ•´ç›®å½•æ ‘ (é™åˆ¶æ·±åº¦) ==="
        find dist -type f 2>/dev/null | head -100 || echo "æ— æ³•åˆ—å‡º dist å†…å®¹"

    - name: ðŸ“„ ä¸Šä¼ æ‰“åŒ…æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: package-logs
        path: |
          package.log
          dist/**/*
        retention-days: 14
        if-no-files-found: warn
