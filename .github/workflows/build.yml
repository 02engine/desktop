name: Build (Manual)

on:
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # x64
          - arch: x64
            format: debian
            artifact: linux-debian-x64
            pattern: "*.deb"
            runner: ubuntu-latest
            snapcraft: false

          - arch: x64
            format: rpm
            artifact: linux-rpm-x64
            pattern: "*.rpm"
            runner: ubuntu-latest
            snapcraft: false

          - arch: x64
            format: pacman
            artifact: linux-pacman-x64
            pattern: "*.pkg.tar.zst"
            runner: ubuntu-latest
            snapcraft: false

          - arch: x64
            format: tarball
            artifact: linux-tarball-x64
            pattern: "*.tar.gz"
            runner: ubuntu-latest
            snapcraft: false

          - arch: x64
            format: appimage
            artifact: linux-appimage-x64
            pattern: "*.AppImage"
            runner: ubuntu-latest
            snapcraft: false

          - arch: x64
            format: snap
            artifact: linux-snap-x64
            pattern: "*.snap"
            runner: ubuntu-latest
            snapcraft: true

          # arm64
          - arch: arm64
            format: debian
            artifact: linux-debian-arm64
            pattern: "*.deb"
            runner: ubuntu-latest
            snapcraft: false

          - arch: arm64
            format: rpm
            artifact: linux-rpm-arm64
            pattern: "*.rpm"
            runner: ubuntu-latest
            snapcraft: false

          - arch: arm64
            format: pacman
            artifact: linux-pacman-arm64
            pattern: "*.pkg.tar.zst"
            runner: ubuntu-latest
            snapcraft: false

          - arch: arm64
            format: tarball
            artifact: linux-tarball-arm64
            pattern: "*.tar.gz"
            runner: ubuntu-latest
            snapcraft: false

          - arch: arm64
            format: appimage
            artifact: linux-appimage-arm64
            pattern: "*.AppImage"
            runner: ubuntu-latest
            snapcraft: false

          - arch: arm64
            format: snap
            artifact: linux-snap-arm64
            pattern: "*.snap"
            runner: ubuntu-latest
            snapcraft: true

          # armv7l
          - arch: armv7l
            format: debian
            artifact: linux-debian-armv7l
            pattern: "*.deb"
            runner: ubuntu-latest
            snapcraft: false

          - arch: armv7l
            format: tarball
            artifact: linux-tarball-armv7l
            pattern: "*.tar.gz"
            runner: ubuntu-latest
            snapcraft: false

          - arch: armv7l
            format: appimage
            artifact: linux-appimage-armv7l
            pattern: "*.AppImage"
            runner: ubuntu-latest
            snapcraft: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install bsdtar for pacman target
        if: matrix.format == 'pacman'
        run: sudo apt-get update && sudo apt-get install -y libarchive-tools

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun ⚙️
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Install snapcraft (for local amd64 snap)
        if: matrix.format == 'snap' && matrix.arch == 'x64'
        run: sudo snap install snapcraft --classic

      - name: Package (all except arm64 snap)
        if: matrix.format != 'snap' || matrix.arch == 'x64'
        run: |
          if [ "${{ matrix.format }}" = "snap" ]; then
            node release-automation/build.js --snap --${{ matrix.arch }}
          else
            node release-automation/build.js --${{ matrix.format }} --${{ matrix.arch }}
          fi

      # ── arm64 snap 使用 remote-build ───────────────────────────────
      - name: Install snapcraft (for remote-build arm64)
        if: matrix.format == 'snap' && matrix.arch == 'arm64'
        run: sudo snap install snapcraft --classic

      - name: Snapcraft remote-build for arm64 only
        if: matrix.format == 'snap' && matrix.arch == 'arm64'
        run: |
          # 强烈建议加上 --launchpad-accept-public-upload 避免交互
          # 如果你的 snapcraft.yaml 有多架构，remote-build 会默认构建所有；
          # 若想强制只构建 arm64，可使用 --build-for=arm64
          snapcraft remote-build --build-for=arm64 --launchpad-accept-public-upload || true

          # remote-build 完成后，snap 文件通常出现在当前目录
          # 常见命名： <snap-name>_<version>_arm64.snap
          SNAP_FILE=$(find . -maxdepth 1 -type f -name "*_arm64.snap" | head -n 1)

          if [ -z "$SNAP_FILE" ]; then
            echo "Error: No arm64 snap file found after remote-build"
            ls -la
            exit 1
          fi

          mkdir -p dist
          mv "$SNAP_FILE" dist/
          echo "Generated snap: $SNAP_FILE"

      - name: Upload artifacts to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.pattern }}

      # ── snap 发布步骤（amd64 和 arm64 都会触发，可根据需要限制） ──
      - name: Publish snap to Snap Store
        if: matrix.format == 'snap' && (github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/'))
        uses: snapcore/action-publish@v1
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
        with:
          snap: dist/*.snap
          release: ${{ startsWith(github.ref, 'refs/tags/') && 'stable' || 'edge' }}

  build-mac:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: modern
            args: --mac --universal
          - target: legacy-10.13-10.14
            args: --mac-legacy-10.13-10.14 --x64
          - target: legacy-10.15
            args: --mac-legacy-10.15 --x64
          - target: legacy-11
            args: --mac-legacy-11 --universal
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun ⚙️
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: node release-automation/build.js ${{ matrix.args }}

      - name: Upload artifacts to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: mac-${{ matrix.target }}
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: nsis-x64
            args: --windows --x64
            files: "*.exe"
          - target: nsis-ia32
            args: --windows --ia32
            files: "*.exe"
          - target: nsis-arm64
            args: --windows --arm64
            files: "*.exe"
          - target: appx-x64
            args: --microsoft-store --x64
            files: "*.appx"
          - target: appx-ia32
            args: --microsoft-store --ia32
            files: "*.appx"
          - target: appx-arm64
            args: --microsoft-store --arm64
            files: "*.appx"
          - target: portable-x64
            args: --windows-portable --x64
            files: "*.exe"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: repo

      - name: "Move repository to D: drive"
        run: |
          Copy-Item -Path repo -Destination D:\repo -Recurse
          Remove-Item -Path repo -Recurse -Force
        shell: pwsh

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun ⚙️
        uses: oven-sh/setup-bun@v2

      - name: "Configure Bun cache and prefix to D: drive"
        run: |
          echo "BUN_INSTALL_CACHE_DIR=D:\bun-cache" >> $GITHUB_ENV
          echo "BUN_INSTALL_GLOBAL_DIR=D:\bun-global" >> $GITHUB_ENV

      - name: Install dependencies
        working-directory: D:\repo
        run: bun install --loglevel=info

      - name: Fetch
        working-directory: D:\repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        working-directory: D:\repo
        run: bun run webpack:prod

      - name: Package
        working-directory: D:\repo
        run: node release-automation/build.js ${{ matrix.args }}

      - name: Upload artifacts to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.target }}
          path: D:\repo\dist\${{ matrix.files }}