name: Build (Manual)

on:
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

  # ── Linux: deb, rpm, pacman(.pkg.tar.zst), tarball, appimage ───────────────────
  build-linux:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        format:
          - name: debian
            arg: --debian
            pattern: "*.deb"
            artifact: linux-debian

          - name: rpm
            arg: --rpm
            pattern: "*.rpm"
            artifact: linux-rpm

          - name: pacman
            arg: --pacman
            pattern: "*.pkg.tar.zst"   # build.js 已自動 rename
            artifact: linux-pkg-tar-zst

          - name: tarball
            arg: --tarball
            pattern: "*.tar.gz"
            artifact: linux-tarball

          - name: appimage
            arg: --appimage
            pattern: "*.AppImage"
            artifact: linux-appimage

        arch:
          - x64
          - arm64
          # - armv7l   # 常失敗，建議測試後決定是否啟用

    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: node release-automation/build.js ${{ matrix.format.arg }} --${{ matrix.arch }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.format.artifact }}-${{ matrix.arch }}
          path: dist/${{ matrix.format.pattern }}
          if-no-files-found: warn

  # ── Snap ───────────────────────────────────────────────────────────────────────
  build-linux-snap:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch:
          - x64
          - armv7l
          - arm64

    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
      SNAPCRAFT_BUILD_ENVIRONMENT: ${{ matrix.arch == 'armv7l' && 'host' || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install snapcraft & dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y snapd
          sudo snap install snapcraft --classic

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package snap (x64 / armv7l native)
        if: matrix.arch != 'arm64'
        run: node release-automation/build.js --snap --${{ matrix.arch }}

      # arm64 使用 qemu + docker 跨平台建置（保留原邏輯）
      - name: Setup QEMU for arm64
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Setup Docker Buildx
        if: matrix.arch == 'arm64'
        uses: docker/setup-buildx-action@v3

      - name: Prepare arm64 build script
        if: matrix.arch == 'arm64'
        run: |
          cat > build-snap-arm64.sh << 'EOF'
          #!/usr/bin/env bash
          set -e
          apt update && apt install -y snapd
          snap install snapcraft --classic
          # snap install core22   # 如有需要特定 base，請取消註解並調整
          bun install --loglevel=info
          bun run fetch
          bun run webpack:prod
          node release-automation/build.js --snap --arm64
          cp dist/*.snap /workspace/ || true
          EOF
          chmod +x build-snap-arm64.sh

      - name: Build snap in arm64 container
        if: matrix.arch == 'arm64'
        run: |
          docker run --rm \
            -v "$(pwd)":/workspace \
            -w /workspace \
            --platform linux/arm64 \
            ubuntu:24.04 \
            bash -c "./build-snap-arm64.sh"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-snap-${{ matrix.arch }}
          path: dist/*.snap
          if-no-files-found: warn

      - name: Find snap file for publish
        id: find-snap
        run: |
          SNAP_FILE=$(find dist -type f -name "*.snap" | head -n 1)
          if [ -z "$SNAP_FILE" ]; then
            echo "No .snap file found"
            exit 1
          fi
          echo "snap_file=$SNAP_FILE" >> $GITHUB_OUTPUT

      - name: Publish to Snap Store
        if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
        uses: snapcore/action-publish@v1
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
        with:
          snap: ${{ steps.find-snap.outputs.snap_file }}
          release: ${{ startsWith(github.ref, 'refs/tags/') && 'stable' || 'edge' }}

  # macOS 保持不變
  build-mac:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: modern
            args: '--mac --universal'
          - target: legacy-10.13-10.14
            args: '--mac-legacy-10.13-10.14 --x64'
          - target: legacy-10.15
            args: '--mac-legacy-10.15 --x64'
          - target: legacy-11
            args: '--mac-legacy-11 --universal'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: node release-automation/build.js ${{ matrix.args }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mac-${{ matrix.target }}
          path: dist/*.dmg

  # Windows 保持不變
  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: modern-nsis-x64
            args: '--windows --x64'
            files: '*.exe'
          - target: modern-nsis-ia32
            args: '--windows --ia32'
            files: '*.exe'
          - target: modern-nsis-arm64
            args: '--windows --arm64'
            files: '*.exe'
          - target: modern-appx-x64
            args: '--microsoft-store --x64'
            files: '*.appx'
          - target: modern-appx-ia32
            args: '--microsoft-store --ia32'
            files: '*.appx'
          - target: modern-appx-arm64
            args: '--microsoft-store --arm64'
            files: '*.appx'
          - target: portable
            args: '--windows-portable --x64'
            files: '*.exe'
          - target: legacy-x64
            args: '--windows-legacy --x64'
            files: '*.exe'
          - target: legacy-ia32
            args: '--windows-legacy --ia32'
            files: '*.exe'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false
          path: repo

      - name: Move to D drive
        shell: pwsh
        run: |
          Copy-Item -Path repo -Destination D:\repo -Recurse
          Remove-Item -Path repo -Recurse -Force

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Configure Bun cache and prefix to D: drive
        run: |
          echo "BUN_INSTALL_CACHE_DIR=D:\bun-cache" >> $GITHUB_ENV
          echo "BUN_INSTALL_GLOBAL_DIR=D:\bun-global" >> $GITHUB_ENV

      - name: Install dependencies
        working-directory: D:\repo
        run: bun install --loglevel=info

      - name: Fetch
        working-directory: D:\repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        working-directory: D:\repo
        run: bun run webpack:prod

      - name: Package
        working-directory: D:\repo
        run: node release-automation/build.js ${{ matrix.args }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.target }}
          path: D:\repo\dist\${{ matrix.files }}