name: Build (Manual)

on:
  workflow_dispatch:

jobs:
  prepare-for-arch:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: convert-script
          path: scripts/convertarch.sh

  # debian 系
  build-linux-debian-x64:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: node release-automation/build.js --debian --x64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-debian-x64
          path: dist/*.deb

  build-linux-debian-armv7l:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: node release-automation/build.js --debian --armv7l

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-debian-armv7l
          path: dist/*.deb

  build-linux-debian-arm64:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: node release-automation/build.js --debian --arm64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-debian-arm64
          path: dist/*.deb

  # tarball 系
  build-linux-tarball-x64:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: node release-automation/build.js --tarball --x64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-tarball-x64
          path: dist/*.tar.gz

  build-linux-tarball-armv7l:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: node release-automation/build.js --tarball --armv7l

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-tarball-armv7l
          path: dist/*.tar.gz

  build-linux-tarball-arm64:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: node release-automation/build.js --tarball --arm64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-tarball-arm64
          path: dist/*.tar.gz

  # AppImage 系
  build-linux-appimage-x64:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: node release-automation/build.js --appimage --x64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage-x64
          path: dist/*.AppImage

  build-linux-appimage-armv7l:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: node release-automation/build.js --appimage --armv7l

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage-armv7l
          path: dist/*.AppImage

  build-linux-appimage-arm64:
    runs-on: ubuntu-latest
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: node release-automation/build.js --appimage --arm64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage-arm64
          path: dist/*.AppImage

  # ── Arch Linux (使用 debtap 转换 deb → pkg.tar.zst) ──

  build-linux-pkg-tar-zst-x64:
    needs: build-linux-debian-x64
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare Arch environment
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm sudo git base-devel namcap libarchive zstd
          useradd -m -s /bin/bash builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/builduser
          echo 'export TERM=xterm' >> /etc/bash.bashrc

      - name: Install and update debtap
        run: |
          sudo -u builduser bash <<'EOF'
          set -e
          export TERM=xterm
          cd /home/builduser
          git clone https://aur.archlinux.org/debtap.git
          cd debtap
          makepkg -si --noconfirm
          EOF
          
          debtap -u
          debtap --version || true

      - name: Download debian-x64 artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-debian-x64
          path: /workspace/dist

      - name: Download convert script artifact
        uses: actions/download-artifact@v4
        with:
          name: convert-script
          path: /workspace/

      - name: Setup workspace
        run: |
          cd /workspace
          mkdir -p arch-packages
          ls -la dist || true

          if [ ! -f convertarch.sh ]; then
            echo "Error: convertarch.sh not found after downloading artifact"
            ls -la .
            exit 1
          fi

          chmod +x convertarch.sh
          sed -i 's/debtap/sudo debtap/g' convertarch.sh || true
          
          find dist -name "*.deb" | sort || true

      - name: Convert packages
        working-directory: /workspace
        run: |
          export TERM=xterm
          ./convertarch.sh

      - name: Verify packages
        working-directory: /workspace
        run: |
          find . -name "*.pkg.tar.zst" -ls 2>/dev/null | head -10 || true
          ls -la arch-packages/ 2>/dev/null || true

      - name: Copy arch files to dist
        run: cp arch-packages/*.pkg.tar.zst dist/ 2>/dev/null || true

      - name: Final check before upload
        working-directory: /workspace
        run: |
          echo "Final files in dist/ ready for upload:"
          ls -la dist/*.pkg.tar.zst || echo "No files to upload!"
          ls -la dist/
          ls -la arch-packages/

      - name: Upload Arch
        uses: actions/upload-artifact@v4
        with:
          name: linux-arch-x64
          path: |
            /workspace/dist/*.pkg.tar.zst

  build-linux-pkg-tar-zst-arm64:
    needs: build-linux-debian-arm64
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare Arch environment
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm sudo git base-devel namcap libarchive zstd
          useradd -m -s /bin/bash builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/builduser
          echo 'export TERM=xterm' >> /etc/bash.bashrc

      - name: Install and update debtap
        run: |
          sudo -u builduser bash <<'EOF'
          set -e
          export TERM=xterm
          cd /home/builduser
          git clone https://aur.archlinux.org/debtap.git
          cd debtap
          makepkg -si --noconfirm
          EOF
          
          debtap -u
          debtap --version || true

      - name: Download debian-arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-debian-arm64
          path: /workspace/dist

      - name: Download convert script artifact
        uses: actions/download-artifact@v4
        with:
          name: convert-script
          path: /workspace/

      - name: Setup workspace
        run: |
          cd /workspace
          mkdir -p arch-packages
          ls -la dist || true

          if [ ! -f convertarch.sh ]; then
            echo "Error: convertarch.sh not found after downloading artifact"
            ls -la .
            exit 1
          fi

          chmod +x convertarch.sh
          sed -i 's/debtap/sudo debtap/g' convertarch.sh || true
          
          find dist -name "*.deb" | sort || true

      - name: Convert packages
        working-directory: /workspace
        run: |
          export TERM=xterm
          ./convertarch.sh

      - name: Verify packages
        working-directory: /workspace
        run: |
          find . -name "*.pkg.tar.zst" -ls 2>/dev/null | head -10 || true
          ls -la arch-packages/ 2>/dev/null || true

      - name: Copy arch files to dist
        run: cp arch-packages/*.pkg.tar.zst dist/ 2>/dev/null || true

      - name: Upload Arch
        uses: actions/upload-artifact@v4
        with:
          name: linux-arch-arm64
          path: |
            /workspace/dist/*.pkg.tar.zst

  build-linux-pkg-tar-zst-armv7l:
    needs: build-linux-debian-armv7l
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare Arch environment
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm sudo git base-devel namcap libarchive zstd
          useradd -m -s /bin/bash builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/builduser
          echo 'export TERM=xterm' >> /etc/bash.bashrc

      - name: Install and update debtap
        run: |
          sudo -u builduser bash <<'EOF'
          set -e
          export TERM=xterm
          cd /home/builduser
          git clone https://aur.archlinux.org/debtap.git
          cd debtap
          makepkg -si --noconfirm
          EOF
          
          debtap -u
          debtap --version || true

      - name: Download debian-armv7l artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-debian-armv7l
          path: /workspace/dist

      - name: Download convert script artifact
        uses: actions/download-artifact@v4
        with:
          name: convert-script
          path: /workspace/

      - name: Setup workspace
        run: |
          cd /workspace
          mkdir -p arch-packages
          ls -la dist || true

          if [ ! -f convertarch.sh ]; then
            echo "Error: convertarch.sh not found after downloading artifact"
            ls -la .
            exit 1
          fi

          chmod +x convertarch.sh
          sed -i 's/debtap/sudo debtap/g' convertarch.sh || true
          
          find dist -name "*.deb" | sort || true

      - name: Convert packages
        working-directory: /workspace
        run: |
          export TERM=xterm
          ./convertarch.sh

      - name: Verify packages
        working-directory: /workspace
        run: |
          find . -name "*.pkg.tar.zst" -ls 2>/dev/null | head -10 || true
          ls -la arch-packages/ 2>/dev/null || true

      - name: Copy arch files to dist
        run: cp arch-packages/*.pkg.tar.zst dist/ 2>/dev/null || true

      - name: Upload Arch
        uses: actions/upload-artifact@v4
        with:
          name: linux-arch-armv7l
          path: |
            /workspace/dist/*.pkg.tar.zst

  # macOS 构建（保持不变）
  build-mac:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: modern
            args: '--mac --universal'
          - target: legacy-10.13-10.14
            args: '--mac-legacy-10.13-10.14 --x64'
          - target: legacy-10.15
            args: '--mac-legacy-10.15 --x64'
          - target: legacy-11
            args: '--mac-legacy-11 --universal'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: |
          node release-automation/build.js ${{ matrix.args }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mac-${{ matrix.target }}
          path: dist/*.dmg

  # Windows 构建（保持不变）
  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: modern-nsis-x64
            args: '--windows --x64'
            files: '*.exe'
          - target: modern-nsis-ia32
            args: '--windows --ia32'
            files: '*.exe'
          - target: modern-nsis-arm64
            args: '--windows --arm64'
            files: '*.exe'
          - target: modern-appx-x64
            args: '--microsoft-store --x64'
            files: '*.appx'
          - target: modern-appx-ia32
            args: '--microsoft-store --ia32'
            files: '*.appx'
          - target: modern-appx-arm64
            args: '--microsoft-store --arm64'
            files: '*.appx'
          - target: portable
            args: '--windows-portable --x64'
            files: '*.exe'
          - target: legacy-x64
            args: '--windows-legacy --x64'
            files: '*.exe'
          - target: legacy-ia32
            args: '--windows-legacy --ia32'
            files: '*.exe'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false
          path: repo

      - name: Move to D drive
        shell: pwsh
        run: |
          Copy-Item -Path repo -Destination D:\repo -Recurse
          Remove-Item -Path repo -Recurse -Force

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: "Configure Bun cache and prefix to D: drive"
        run: |
          echo "BUN_INSTALL_CACHE_DIR=D:\bun-cache" >> $GITHUB_ENV
          echo "BUN_INSTALL_GLOBAL_DIR=D:\bun-global" >> $GITHUB_ENV

      - name: Install dependencies
        working-directory: D:\repo
        run: bun install --loglevel=info

      - name: Fetch
        working-directory: D:\repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        working-directory: D:\repo
        run: bun run webpack:prod

      - name: Package
        working-directory: D:\repo
        run: |
          node release-automation/build.js ${{ matrix.args }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.target }}
          path: D:\repo\dist\${{ matrix.files }}