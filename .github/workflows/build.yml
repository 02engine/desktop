name: Build (Manual)

on:
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # x64
          - name: debian-x64
            arch: x64
          - name: rpm-x64
            arch: x64
          - name: pacman-x64
            arch: x64
          - name: tarball-x64
            arch: x64
          - name: appimage-x64
            arch: x64
          - name: snap-x64
            arch: x64

          # arm64
          - name: debian-arm64
            arch: arm64
          - name: rpm-arm64
            arch: arm64
          - name: pacman-arm64
            arch: arm64
          - name: tarball-arm64
            arch: arm64
          - name: appimage-arm64
            arch: arm64

          # armv7l
          - name: debian-armv7l
            arch: armv7l
          - name: tarball-armv7l
            arch: armv7l
          - name: appimage-armv7l
            arch: armv7l

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install bsdtar for pacman target
        if: contains(matrix.name, 'pacman')
        run: sudo apt-get update && sudo apt-get install -y libarchive-tools

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Install snapcraft (only for snap)
        if: contains(matrix.name, 'snap')
        run: sudo snap install snapcraft --classic

      - name: Package
        run: |
          if [ "${{ matrix.name }}" = "snap-x64" ]; then
            node release-automation/build.js --snap --${{ matrix.arch }}
          else
            format=$(echo ${{ matrix.name }} | cut -d'-' -f1)
            node release-automation/build.js --$format --${{ matrix.arch }}
          fi

      - name: Upload artifacts to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.name }}
          path: dist/*

  build-mac:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: modern
            args: --mac --universal
          - name: legacy-10.13-10.14
            args: --mac-legacy-10.13-10.14 --x64
          - name: legacy-10.15
            args: --mac-legacy-10.15 --x64
          - name: legacy-11
            args: --mac-legacy-11 --universal
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: node release-automation/build.js ${{ matrix.args }}

      - name: Upload artifacts to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: mac-${{ matrix.name }}
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: nsis-x64
            args: --windows --x64
            files: "*.exe"
          - name: nsis-ia32
            args: --windows --ia32
            files: "*.exe"
          - name: nsis-arm64
            args: --windows --arm64
            files: "*.exe"
          - name: appx-x64
            args: --microsoft-store --x64
            files: "*.appx"
          - name: appx-ia32
            args: --microsoft-store --ia32
            files: "*.appx"
          - name: appx-arm64
            args: --microsoft-store --arm64
            files: "*.appx"
          - name: portable-x64
            args: --windows-portable --x64
            files: "*.exe"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: repo

      - name: "Move repository to D: drive"
        run: |
          Copy-Item -Path repo -Destination D:\repo -Recurse
          Remove-Item -Path repo -Recurse -Force
        shell: pwsh

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun
        uses: oven-sh/setup-bun@v2

      - name: "Configure Bun cache and prefix to D: drive"
        run: |
          echo "BUN_INSTALL_CACHE_DIR=D:\bun-cache" >> $GITHUB_ENV
          echo "BUN_INSTALL_GLOBAL_DIR=D:\bun-global" >> $GITHUB_ENV

      - name: Install dependencies
        working-directory: D:\repo
        run: bun install --loglevel=info

      - name: Fetch
        working-directory: D:\repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        working-directory: D:\repo
        run: bun run webpack:prod

      - name: Package
        working-directory: D:\repo
        run: node release-automation/build.js ${{ matrix.args }}

      - name: Upload artifacts to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.name }}
          path: D:\repo\dist\${{ matrix.files }}
