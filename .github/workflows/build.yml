name: Build (Manual)

on:
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ${{ matrix.runner }}
    env:
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
      SNAPCRAFT_DESTRUCTIVE_MODE: 1
    strategy:
      fail-fast: false
      matrix:
        include:
          # x64
          - arch: x64
            format: debian
            artifact: linux-debian-x64
            pattern: "*.deb"
            runner: ubuntu-latest
            snapcraft: false

          - arch: x64
            format: rpm
            artifact: linux-rpm-x64
            pattern: "*.rpm"
            runner: ubuntu-latest
            snapcraft: false

          - arch: x64
            format: pacman
            artifact: linux-pacman-x64
            pattern: "*.pkg.tar.zst"
            runner: ubuntu-latest
            snapcraft: false

          - arch: x64
            format: tarball
            artifact: linux-tarball-x64
            pattern: "*.tar.gz"
            runner: ubuntu-latest
            snapcraft: false

          - arch: x64
            format: appimage
            artifact: linux-appimage-x64
            pattern: "*.AppImage"
            runner: ubuntu-latest
            snapcraft: false

          - arch: x64
            format: snap
            artifact: linux-snap-x64
            pattern: "*.snap"
            runner: ubuntu-latest
            snapcraft: true

          # arm64
          - arch: arm64
            format: debian
            artifact: linux-debian-arm64
            pattern: "*.deb"
            runner: ubuntu-latest
            snapcraft: false

          - arch: arm64
            format: rpm
            artifact: linux-rpm-arm64
            pattern: "*.rpm"
            runner: ubuntu-latest
            snapcraft: false

          - arch: arm64
            format: pacman
            artifact: linux-pacman-arm64
            pattern: "*.pkg.tar.zst"
            runner: ubuntu-latest
            snapcraft: false

          - arch: arm64
            format: tarball
            artifact: linux-tarball-arm64
            pattern: "*.tar.gz"
            runner: ubuntu-latest
            snapcraft: false

          - arch: arm64
            format: appimage
            artifact: linux-appimage-arm64
            pattern: "*.AppImage"
            runner: ubuntu-latest
            snapcraft: false

          - arch: arm64
            format: snap
            artifact: linux-snap-arm64
            pattern: "*.snap"
            runner: ubuntu-latest
            snapcraft: true

          # armv7l
          - arch: armv7l
            format: debian
            artifact: linux-debian-armv7l
            pattern: "*.deb"
            runner: ubuntu-latest
            snapcraft: false

          - arch: armv7l
            format: tarball
            artifact: linux-tarball-armv7l
            pattern: "*.tar.gz"
            runner: ubuntu-latest
            snapcraft: false

          - arch: armv7l
            format: appimage
            artifact: linux-appimage-armv7l
            pattern: "*.AppImage"
            runner: ubuntu-latest
            snapcraft: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install bsdtar for pacman target
        if: matrix.format == 'pacman'
        run: sudo apt-get update && sudo apt-get install -y libarchive-tools

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun ⚙️
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Install snapcraft
        if: matrix.snapcraft
        run: sudo snap install snapcraft --classic

      - name: Package
        run: |
          if [ "${{ matrix.snapcraft }}" = "true" ]; then
            # 先打包成 unpacked 目录（electron-builder 会下载对应架构的 Electron）
            node release-automation/build.js --linux dir --${{ matrix.arch }}
            
            # 手动调用 snapcraft，强制 destructive mode + 指定目标架构
            snapcraft --destructive-mode --build-for=${{ matrix.arch }}
          else
            # 其他格式正常调用
            node release-automation/build.js --${{ matrix.format }} --${{ matrix.arch }}
          fi

      - name: Upload artifacts to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.pattern }}

      # snap 文件查找
      - if: matrix.snapcraft
        id: find-snap
        run: |
          SNAP_FILE=$(find dist -type f -name "*.snap" | head -n 1)
          [ -z "$SNAP_FILE" ] && exit 1
          echo "snap_file=$SNAP_FILE" >> $GITHUB_OUTPUT

      # publish
      - if: matrix.snapcraft && (github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/'))
        uses: snapcore/action-publish@v1
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
        with:
          snap: ${{ steps.find-snap.outputs.snap_file }}
          release: ${{ startsWith(github.ref, 'refs/tags/') && 'stable' || 'edge' }}

  build-mac:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: modern
            args: --mac --universal
          - target: legacy-10.13-10.14
            args: --mac-legacy-10.13-10.14 --x64
          - target: legacy-10.15
            args: --mac-legacy-10.15 --x64
          - target: legacy-11
            args: --mac-legacy-11 --universal
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun ⚙️
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --loglevel=info

      - name: Fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        run: bun run webpack:prod

      - name: Package
        run: node release-automation/build.js ${{ matrix.args }}

      - name: Upload artifacts to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: mac-${{ matrix.target }}
          path: dist/*.dmg

  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: nsis-x64
            args: --windows --x64
            files: "*.exe"
          - target: nsis-ia32
            args: --windows --ia32
            files: "*.exe"
          - target: nsis-arm64
            args: --windows --arm64
            files: "*.exe"
          - target: appx-x64
            args: --microsoft-store --x64
            files: "*.appx"
          - target: appx-ia32
            args: --microsoft-store --ia32
            files: "*.appx"
          - target: appx-arm64
            args: --microsoft-store --arm64
            files: "*.appx"
          - target: portable-x64
            args: --windows-portable --x64
            files: "*.exe"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: repo

      - name: "Move repository to D: drive"
        run: |
          Copy-Item -Path repo -Destination D:\repo -Recurse
          Remove-Item -Path repo -Recurse -Force
        shell: pwsh

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup bun ⚙️
        uses: oven-sh/setup-bun@v2

      - name: "Configure Bun cache and prefix to D: drive"
        run: |
          echo "BUN_INSTALL_CACHE_DIR=D:\bun-cache" >> $GITHUB_ENV
          echo "BUN_INSTALL_GLOBAL_DIR=D:\bun-global" >> $GITHUB_ENV

      - name: Install dependencies
        working-directory: D:\repo
        run: bun install --loglevel=info

      - name: Fetch
        working-directory: D:\repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun run fetch

      - name: Compile
        working-directory: D:\repo
        run: bun run webpack:prod

      - name: Package
        working-directory: D:\repo
        run: node release-automation/build.js ${{ matrix.args }}

      - name: Upload artifacts to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.target }}
          path: D:\repo\dist\${{ matrix.files }}