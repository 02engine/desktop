id: io.github._02engine._02Engine
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node20   # 如果升级到 node24，请改这里
command: 02engine

finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --socket=alsa
  - --device=dri
  - --filesystem=xdg-download
  - --filesystem=xdg-documents:ro
  - --filesystem=xdg-pictures:ro
  - --filesystem=xdg-music:ro
  - --filesystem=xdg-videos:ro
  - --share=network

modules:
  # 离线依赖模块（保持不变）
  - name: node-deps
    buildsystem: simple
    build-options:
      env:
        XDG_CACHE_HOME: /run/build/flatpak-node/cache
    sources:
      - type: dir
        path: flatpak
        dest: flatpak-node
      - flatpak/generated-sources.json
    build-commands:
      - true

  # 主应用模块（加入大量 debug）
  - name: 02Engine
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node20/bin:$PATH  # 确保 node 和 npm 在 PATH 中
      env:
        npm_config_nodedir: /usr/lib/sdk/node20
        npm_config_cache: /run/build/flatpak-node/npm-cache
        npm_config_offline: 'true'
        ELECTRON_ENABLE_LOGGING: '1'

    sources:
      - type: git
        url: https://github.com/02engine/desktop.git
        tag: v1.2.2
        commit: e5a6cd210eed10c7ff520b7e42808033cc2e7ca8
      - type: file
        url: https://raw.githubusercontent.com/02engine/desktop/main/art/icon.png
        dest-filename: icon.png
        sha256: f18ada96f6c02e9948ac8297e373089585a53c54d77ed77afa26f671140df7f8
      - type: file
        url: https://raw.githubusercontent.com/02engine/desktop/main/flatpak/package-lock.json
        dest-filename: package-lock.json
        sha256: 191a5d5ce4bc8ef0f19c9c0fcba6a0b2ef68b048705764d7ee8ef0771e430302

    build-commands:
      # ──────────────────────────────── DEBUG 开始 ────────────────────────────────
      # 1. 检查 node 和 npm 是否可用
      - echo "=== DEBUG: 检查 Node 和 npm 可用性 ==="
      - which node || echo "node not found"
      - node --version || echo "node version failed"
      - which npm || echo "npm not found"
      - npm --version || echo "npm version failed"

      # 2. 检查缓存目录是否存在及内容
      - echo "=== DEBUG: 检查 npm 缓存目录 ==="
      - ls -la /run/build/flatpak-node/npm-cache || echo "npm cache dir not found"
      - du -sh /run/build/flatpak-node/npm-cache || echo "cache size unknown"
      - find /run/build/flatpak-node/npm-cache -type f | wc -l || echo "no files in cache"

      # 3. 检查 package-lock.json 是否存在
      - echo "=== DEBUG: 检查 package-lock.json ==="
      - ls -l package-lock.json || echo "package-lock.json missing"
      - head -n 20 package-lock.json || echo "cannot read package-lock.json"

      # 4. 检查当前工作目录内容
      - echo "=== DEBUG: 当前工作目录内容 ==="
      - ls -la

      # ──────────────────────────────── DEBUG 结束 ────────────────────────────────

      # 尝试离线安装（使用 ci 更严格，强制使用 lockfile）
      - npm ci --prefer-offline --offline --no-audit --no-fund --ignore-scripts --legacy-peer-deps --force --no-package-lock || npm install --prefer-offline --offline --no-audit --no-fund --ignore-scripts --legacy-peer-deps --force

      # 如果安装失败，输出 npm 日志（日志文件路径来自你的错误信息）
      - cat /run/build/flatpak-node/npm-cache/_logs/*-debug-*.log || echo "No npm debug log found"

      # 继续后续步骤（如果安装成功）
      - npm run fetch || true
      - npm run webpack:prod
      - npm run release-automation/build.js --linux-dir --x64

      # 复制构建结果
      - mkdir -p /app/main
      - cp -a dist/linux-unpacked/* /app/main/ || echo "dist/linux-unpacked not found"

      # 安装图标
      - install -Dm644 icon.png /app/share/icons/hicolor/512x512/apps/io.github._02engine._02Engine.png

      # 创建启动脚本
      - |
        cat > /app/bin/02engine << 'EOF'
        #!/usr/bin/env bash
        set -euo pipefail
        exec /app/main/02Engine "$@"
        EOF
      - chmod +x /app/bin/02engine

      # 创建桌面文件
      - |
        cat > /app/share/applications/io.github._02engine._02Engine.desktop << 'EOF'
        [Desktop Entry]
        Name=02Engine
        Exec=02engine %U
        Terminal=false
        Type=Application
        Icon=io.github._02engine._02Engine
        StartupWMClass=02Engine-desktop
        Comment=Better Scratch. Based on Turbowarp.
        MimeType=application/x.scratch.sb3;application/x.scratch.sb2;application/x.scratch.sb;
        Categories=Development;Education;
        Keywords=scratch;programming;animation;
        EOF

      # 创建元数据文件
      - |
        cat > /app/share/metainfo/io.github._02engine._02Engine.metainfo.xml << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <component type="desktop-application">
          <id>io.github._02engine._02Engine</id>
          <launchable type="desktop-id">io.github._02engine._02Engine.desktop</launchable>
          <metadata_license>CC0-1.0</metadata_license>
          <project_license>GPL-3.0</project_license>
          <name>02Engine</name>
          <developer id="io.github._02engine">
            <name>02Studio</name>
          </developer>
          <summary>Better Scratch. Based on TurboWarp.</summary>
          <description>
            <p>02Engine is a Scratch mod based on TurboWarp with enhanced features for designing and animating.</p>
            <p>Features:</p>
            <ul>
              <li>Runs projects up to 100x faster than Scratch</li>
              <li>Dark mode for comfortable editing</li>
              <li>Many addons to improve the editor experience</li>
              <li>Native filesystem integration</li>
              <li>Support for .sb3, .sb2, and .sb project files</li>
            </ul>
          </description>
          <screenshots>
            <screenshot type="default">
              <image>https://raw.githubusercontent.com/02engine/desktop/main/art/icon.png</image>
            </screenshot>
          </screenshots>
          <url type="homepage">https://02engine.org/</url>
          <url type="bugtracker">https://github.com/02engine/desktop/issues</url>
          <url type="vcs-browser">https://github.com/02engine/desktop</url>
          <categories>
            <category>Development</category>
            <category>Education</category>
          </categories>
          <keywords>
            <keyword>scratch</keyword>
            <keyword>programming</keyword>
            <keyword>animation</keyword>
          </keywords>
          <recommends>
            <control>pointing</control>
            <control>keyboard</control>
          </recommends>
          <supports>
            <control>touch</control>
          </supports>
          <content_rating type="oars-1.1">
            <content_attribute id="social-chat">mild</content_attribute>
            <content_attribute id="social-info">mild</content_attribute>
          </content_rating>
        </component>
        EOF

      - ln -s /app/bin/02engine /app/bin/io.github._02engine._02Engine